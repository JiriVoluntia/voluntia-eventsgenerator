<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voluntia Event Generator</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;900&display=swap" rel="stylesheet" />

<style>
  body {
    font-family: 'Inter', sans-serif;
    margin: 0; padding: 10px;
    display: flex; flex-wrap: wrap;
    justify-content: center;
    background: #f0f0f0;
    gap: 20px;
  }
  #canvas-container {
    flex: 1 1 650px;
    max-width: 1080px;
    background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
  }
  canvas {
    width: 100% !important;
    height: auto !important;
    max-width: 1080px;
    border: 1px solid #ccc;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-touch-callout: none;
  }
  #controls {
    flex: 0 0 320px;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    box-sizing: border-box;
  }
  #controls label {
    font-weight: 600;
    display: block;
    margin-bottom: 6px;
    margin-top: 14px;
    font-size: 14px;
  }
  #controls input[type=text],
  #controls input[type=file] {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border-radius: 4px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  #controls button {
    margin-top: 20px;
    width: 100%;
    padding: 15px;
    font-weight: 700;
    font-size: 16px;
    color: #000;
    background: #FED801;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  #controls button:hover {
    background: #e1c500;
  }

  @media (max-width: 900px) {
    body {
      flex-direction: column;
      align-items: center;
    }
    #controls {
      flex: 1 1 100%;
      max-width: 100%;
      margin-top: 15px;
    }
  }
</style>
</head>
<body>

<div id="canvas-container">
  <canvas id="eventCanvas" width="1080" height="1080"></canvas>
</div>

<div id="controls">
  <label for="inputTitle">Název akce</label>
  <input type="text" id="inputTitle" placeholder="Název akce" value="Voluntia setkání v Liberci" />

  <label for="inputPlace">Místo</label>
  <input type="text" id="inputPlace" placeholder="Místo" value="Pivovarský dvůr, Papírové náměstí" />

  <label for="inputTime">Čas</label>
  <input type="text" id="inputTime" placeholder="Čas" value="25. září v 18:00" />

  <label for="inputAuthor">Zpracovatel</label>
  <input type="text" id="inputAuthor" placeholder="Zpracovatel" value="zadavatel/zpracovatel: Voluntia" />

  <label for="inputBackground">Nahrát vlastní pozadí</label>
  <input type="file" id="inputBackground" accept="image/*" />

  <label for="inputPersons">Nahrát fotky osob</label>
  <input type="file" id="inputPersons" multiple accept="image/*" />

  <button id="downloadBtn">Stáhnout obrázek</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
<script>
  const canvas = new fabric.Canvas('eventCanvas', {
    preserveObjectStacking: true,
    selection: true,
    perPixelTargetFind: true,
    targetFindTolerance: 4,
    stopContextMenu: true
  });

  const assets = {
    shadowPozadi: 'assets/Shadow-pozadi.jpg',
    pozadi: 'assets/Celkovy-obrazek.jpg',
    shadowPredni: 'assets/Shadow-predni.jpg',
    spodniLista: 'assets/Spodni-lista.jpg',
    lokaceZnak: 'assets/Lokace-znak.jpg',
    hodinyZnak: 'assets/Hodiny-znak.jpg'
  };

  let userBackgroundImage = null;
  let shadowFrontImage = null;

  async function loadImage(url, options = {}) {
    return new Promise((resolve) => {
      fabric.Image.fromURL(url, img => {
        if (options.scale) img.scale(options.scale);
        if (options.left !== undefined) img.left = options.left;
        if (options.top !== undefined) img.top = options.top;
        if (options.width !== undefined) img.width = options.width;
        if (options.height !== undefined) img.height = options.height;
        if (options.hasControls !== undefined) img.hasControls = options.hasControls;
        if (options.selectable !== undefined) img.selectable = options.selectable;
        if (options.customType) img.customType = options.customType; // for layering
        img.set({...options});
        resolve(img);
      }, {crossOrigin: 'anonymous'});
    });
  }

  async function setupCanvas() {
    canvas.clear();

    const shadowPozadi = await loadImage(assets.shadowPozadi, {left:0, top:0, selectable:false, customType:'shadowPozadi'});
    const pozadi = await loadImage(assets.pozadi, {left:0, top:0, selectable:false, customType:'pozadi'});
    const spodniLista = await loadImage(assets.spodniLista, {left:0, top:972, selectable:false, customType:'spodniLista'});
    const lokaceZnak = await loadImage(assets.lokaceZnak, {left:40, top:824, selectable:false, width:37, height:37, customType:'lokaceZnak'});
    const hodinyZnak = await loadImage(assets.hodinyZnak, {left:40, top:884, selectable:false, width:37, height:37, customType:'hodinyZnak'});

    canvas.add(shadowPozadi);
    canvas.add(pozadi);
    canvas.add(spodniLista);
    canvas.add(lokaceZnak);
    canvas.add(hodinyZnak);

    addTextObjects();

    reorderLayers();

    canvas.renderAll();
  }

  let texts = {};
  function addTextObjects() {
    const fontFamily = 'Inter, sans-serif';

    texts.title = new fabric.Textbox(document.getElementById('inputTitle').value, {
      left:40, top: 586, fontFamily, fontWeight: '900', fontSize: 90, fill: '#fff',
      shadow: new fabric.Shadow({color: 'rgba(0,0,0,0.25)', blur: 3, offsetX: 0, offsetY: 3}),
      selectable: false, width: 1000, customType:'textTitle'
    });
    texts.place = new fabric.Textbox(document.getElementById('inputPlace').value, {
      left:93, top: 811, fontFamily, fontWeight: '700', fontSize: 50, fill: '#FED801',
      shadow: new fabric.Shadow({color: 'rgba(0,0,0,0.25)', blur: 2, offsetX: 0, offsetY: 2}),
      selectable: false, width: 950, customType:'textPlace'
    });
    texts.time = new fabric.Textbox(document.getElementById('inputTime').value, {
      left:93, top: 874, fontFamily, fontWeight: '700', fontSize: 50, fill: '#FED801',
      shadow: new fabric.Shadow({color: 'rgba(0,0,0,0.25)', blur: 2, offsetX: 0, offsetY: 2}),
      selectable: false, width: 950, customType:'textTime'
    });
    texts.author = new fabric.Textbox(document.getElementById('inputAuthor').value || 'zadavatel/zpracovatel: Voluntia', {
      left:815, top: 930, fontFamily, fontWeight: '600', fontSize: 14, fill: 'rgba(255,255,255,0.7)',
      textAlign: 'right', selectable: false, width: 250, customType:'textAuthor'
    });

    canvas.add(texts.title, texts.place, texts.time, texts.author);
  }

  function reorderLayers() {
    const objs = canvas.getObjects();
    const pozadi = objs.find(o => o.customType === 'pozadi');
    const shadowPozadi = objs.find(o => o.customType === 'shadowPozadi');
    const spodniLista = objs.find(o => o.customType === 'spodniLista');
    const lokaceZnak = objs.find(o => o.customType === 'lokaceZnak');
    const hodinyZnak = objs.find(o => o.customType === 'hodinyZnak');
    const shadowPredni = objs.find(o => o.customType === 'shadowPredni');
    const osoby = objs.filter(o => o.customType === 'osoba');
    const textTitle = objs.find(o => o.customType === 'textTitle');
    const textPlace = objs.find(o => o.customType === 'textPlace');
    const textTime = objs.find(o => o.customType === 'textTime');
    const textAuthor = objs.find(o => o.customType === 'textAuthor');

    let idx = 0;
    if(pozadi) canvas.moveTo(pozadi, idx++);
    if(shadowPozadi) canvas.moveTo(shadowPozadi, idx++);
    osoby.forEach(osoba => canvas.moveTo(osoba, idx++));
    if(shadowPredni) canvas.moveTo(shadowPredni, idx++);
    if(spodniLista) canvas.moveTo(spodniLista, idx++);
    if(lokaceZnak) canvas.moveTo(lokaceZnak, idx++);
    if(hodinyZnak) canvas.moveTo(hodinyZnak, idx++);
    if(textTime) canvas.moveTo(textTime, idx++);
    if(textPlace) canvas.moveTo(textPlace, idx++);
    if(textTitle) canvas.moveTo(textTitle, idx++);
    if(textAuthor) canvas.moveTo(textAuthor, idx++);
  }

  document.getElementById('inputBackground').addEventListener('change', e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      fabric.Image.fromURL(event.target.result, img => {
        if(userBackgroundImage) canvas.remove(userBackgroundImage);
        img.set({left: 0, top: 0, selectable: false, evented: false, customType: 'pozadi'});
        img.scaleToWidth(canvas.width);
        img.scaleToHeight(canvas.height);
        canvas.insertAt(img, 0);
        userBackgroundImage = img;
        reorderLayers();
        canvas.renderAll();
      });
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('inputPersons').addEventListener('change', e => {
    const files = e.target.files;
    if(!files.length) return;

    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(event) {
        fabric.Image.fromURL(event.target.result, img => {
          img.set({
            left: 300, top: 200,
            scaleX: 0.5, scaleY: 0.5,
            hasBorders: true, hasControls: true,
            selectable: true, evented: true,
            hoverCursor: 'move',
            customType: 'osoba'
          });
          canvas.add(img);
          canvas.setActiveObject(img);
          reorderLayers();
          canvas.renderAll();
        });
      };
      reader.readAsDataURL(file);
    });
  });

  async function addShadowPredni() {
    if(shadowFrontImage) {
      canvas.remove(shadowFrontImage);
      shadowFrontImage = null;
    }
    const img = await loadImage(assets.shadowPredni, {left:0, top:0, selectable:false, customType:'shadowPredni'});
    shadowFrontImage = img;
    canvas.add(img);
    reorderLayers();
    canvas.renderAll();
  }

  document.addEventListener('keydown', e => {
    if(e.key === 'Delete' || e.key === 'Backspace') {
      const active = canvas.getActiveObject();
      if(active && active.selectable) {
        canvas.remove(active);
        canvas.discardActiveObject();
        reorderLayers();
        canvas.renderAll();
      }
    }
  });

  ['inputTitle', 'inputPlace', 'inputTime', 'inputAuthor'].forEach(id => {
    document.getElementById(id).addEventListener('input', e => {
      const val = e.target.value;
      switch(e.target.id) {
        case 'inputTitle': if(texts.title) texts.title.text = val; break;
        case 'inputPlace': if(texts.place) texts.place.text = val; break;
        case 'inputTime': if(texts.time) texts.time.text = val; break;
        case 'inputAuthor': if(texts.author) texts.author.text = val || 'zadavatel/zpracovatel: Voluntia'; break;
      }
      canvas.renderAll();
    });
  });

  setupCanvas();
</script>

</body>
</html>

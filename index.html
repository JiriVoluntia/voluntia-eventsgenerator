<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voluntia Event Generator s Editačním Panelem</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;900&display=swap" rel="stylesheet" />

<style>
  body {
    font-family: 'Inter', sans-serif;
    margin: 0; padding: 10px;
    display: flex;
    gap: 20px;
    background: #f0f0f0;
    height: 100vh;
    overflow: hidden;
  }
  #canvas-container {
    flex: 1 1 auto;
    max-width: 1080px;
    background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
  }
  canvas {
    width: 100% !important;
    height: auto !important;
    border: 1px solid #ccc;
    user-select: none;
  }
  #layer-panel {
    flex: 0 0 300px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    overflow-y: auto;
  }
  #layer-panel h3 {
    margin: 0;
    padding: 10px;
    background: #FED801;
    font-weight: 700;
    text-align: center;
  }
  #layer-list {
    list-style: none;
    margin: 0; padding: 0;
    max-height: 75vh;
  }
  #layer-list li {
    padding: 8px 10px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #layer-list li.selected {
    background: #fffbe6;
  }
  #layer-list li .layer-name {
    flex-grow: 1;
    user-select: none;
  }
  #layer-list li button.delete-btn {
    font-size: 16px;
    background: none;
    border: none;
    color: #d33;
    cursor: pointer;
  }
  #edit-panel {
    padding: 10px;
    border-top: 1px solid #ddd;
  }
  #edit-panel label {
    display: block;
    margin: 6px 0 3px;
  }
  #edit-panel input[type=text] {
    width: 100%;
    padding: 6px;
    font-size: 14px;
    box-sizing: border-box;
  }
</style>
</head>
<body>

<div id="canvas-container">
  <canvas id="eventCanvas" width="1080" height="1080"></canvas>
</div>

<div id="layer-panel">
  <h3>Vrstva hierarchie</h3>
  <ul id="layer-list"></ul>
  <div id="edit-panel" style="display:none;">
    <label for="edit-text">Upravit text</label>
    <input type="text" id="edit-text" />
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
<script>
  const canvas = new fabric.Canvas('eventCanvas', {
    preserveObjectStacking: true,
    selection: true,
    perPixelTargetFind: true,
    targetFindTolerance: 4,
  });

  // Základní assety a proměnné
  const assets = {
    shadowPozadi: 'assets/Shadow-pozadi.jpg',
    pozadi: 'assets/Celkovy-obrazek.jpg',
    shadowPredni: 'assets/Shadow-predni.jpg',
    spodniLista: 'assets/Spodni-lista.jpg',
    lokaceZnak: 'assets/Lokace-znak.jpg',
    hodinyZnak: 'assets/Hodiny-znak.jpg'
  };
  let userBackgroundImage = null;
  let shadowFrontImage = null;

  let texts = {};
  let selectedObject = null;

  // Nahrání obrázku s extra vlastností
  async function loadImage(url, options = {}) {
    return new Promise((resolve) => {
      fabric.Image.fromURL(url, img => {
        img.set({...options});
        resolve(img);
      });
    });
  }

  // Zaplnění canvasu základními objekty
  async function setupCanvas() {
    canvas.clear();
    selectedObject = null;

    const shadowPozadi = await loadImage(assets.shadowPozadi, {left:0, top:0, selectable:false, evented:false, customType:'shadowPozadi'});
    const pozadi = await loadImage(assets.pozadi, {left:0, top:0, selectable:false, evented:false, customType:'pozadi'});
    const spodniLista = await loadImage(assets.spodniLista, {left:0, top:972, selectable:false, evented:false, customType:'spodniLista'});
    const lokaceZnak = await loadImage(assets.lokaceZnak, {left:40, top:824, selectable:false, evented:false, width:37, height:37, customType:'lokaceZnak'});
    const hodinyZnak = await loadImage(assets.hodinyZnak, {left:40, top:884, selectable:false, evented:false, width:37, height:37, customType:'hodinyZnak'});

    canvas.add(shadowPozadi);
    canvas.add(pozadi);
    canvas.add(spodniLista);
    canvas.add(lokaceZnak);
    canvas.add(hodinyZnak);

    addTextObjects();
    await addShadowPredni();

    reorderLayers();

    updateLayerPanel();
    canvas.renderAll();
  }

  function addTextObjects() {
    const fontFamily = 'Inter, sans-serif';
    texts.title = new fabric.Textbox(document.getElementById('inputTitle').value, {
      left:40, top:586, fontFamily, fontWeight: '900', fontSize: 90,
      fill: '#fff',
      shadow: new fabric.Shadow({color:'rgba(0,0,0,0.25)', blur:3, offsetX:0, offsetY:3}),
      selectable: false, evented: false,
      width: 1000, customType: 'textTitle'
    });

    texts.place = new fabric.Textbox(document.getElementById('inputPlace').value, {
      left:93, top:811, fontFamily, fontWeight: '700', fontSize: 50,
      fill: '#FED801',
      shadow: new fabric.Shadow({color:'rgba(0,0,0,0.25)', blur:2, offsetX:0, offsetY:2}),
      selectable: false, evented: false,
      width: 950, customType: 'textPlace'
    });

    texts.time = new fabric.Textbox(document.getElementById('inputTime').value, {
      left:93, top:874, fontFamily, fontWeight: '700', fontSize: 50,
      fill: '#FED801',
      shadow: new fabric.Shadow({color:'rgba(0,0,0,0.25)', blur:2, offsetX:0, offsetY:2}),
      selectable: false, evented: false,
      width: 950, customType: 'textTime'
    });

    texts.author = new fabric.Textbox(document.getElementById('inputAuthor').value || 'zadavatel/zpracovatel: Voluntia', {
      left:815, top:930, fontFamily, fontWeight: '600', fontSize: 14,
      fill: 'rgba(255,255,255,0.7)',
      textAlign:'right', selectable: false, evented: false,
      width: 250, customType: 'textAuthor'
    });

    canvas.add(texts.title, texts.place, texts.time, texts.author);
  }

  async function addShadowPredni() {
    if (shadowFrontImage) {
      canvas.remove(shadowFrontImage);
      shadowFrontImage = null;
    }
    shadowFrontImage = await loadImage(assets.shadowPredni, {
      left: 0,
      top: 0,
      selectable: false,
      evented: false,
      opacity: 0.6,
      customType: 'shadowPredni'
    });
    canvas.add(shadowFrontImage);
    reorderLayers();
  }

  function reorderLayers() {
    const objs = canvas.getObjects();

    const pozadi = objs.find(o => o.customType === 'pozadi');
    const shadowPozadi = objs.find(o => o.customType === 'shadowPozadi');
    const shadowPredni = objs.find(o => o.customType === 'shadowPredni');
    const spodniLista = objs.find(o => o.customType === 'spodniLista');
    const lokaceZnak = objs.find(o => o.customType === 'lokaceZnak');
    const hodinyZnak = objs.find(o => o.customType === 'hodinyZnak');
    const textTitle = objs.find(o => o.customType === 'textTitle');
    const textPlace = objs.find(o => o.customType === 'textPlace');
    const textTime = objs.find(o => o.customType === 'textTime');
    const textAuthor = objs.find(o => o.customType === 'textAuthor');

    const osoby = objs.filter(o => o.customType === 'osoba');

    let idx = 0;
    if (pozadi) canvas.moveTo(pozadi, idx++);
    if (shadowPozadi) canvas.moveTo(shadowPozadi, idx++);
    if (shadowPredni) canvas.moveTo(shadowPredni, idx++); // mezi shadow pozadi a osobami
    osoby.forEach(o => canvas.moveTo(o, idx++));
    if (spodniLista) canvas.moveTo(spodniLista, idx++);
    if (lokaceZnak) canvas.moveTo(lokaceZnak, idx++);
    if (hodinyZnak) canvas.moveTo(hodinyZnak, idx++);
    if (textTime) canvas.moveTo(textTime, idx++);
    if (textPlace) canvas.moveTo(textPlace, idx++);
    if (textTitle) canvas.moveTo(textTitle, idx++);
    if (textAuthor) canvas.moveTo(textAuthor, idx++);
  }

  function updateLayerPanel() {
    const layerList = document.getElementById('layer-list');
    layerList.innerHTML = '';

    const objs = canvas.getObjects().slice().reverse(); // nejvyšší v poli bude první v seznamu

    objs.forEach(obj => {
      const li = document.createElement('li');
      li.textContent = obj.customType || obj.type;

      if (obj === selectedObject) li.classList.add('selected');

      li.addEventListener('click', () => {
        canvas.setActiveObject(obj);
        selectedObject = obj;
        updateLayerPanel();
        updateEditPanel();
      });

      // tlačítko na smazání
      const delBtn = document.createElement('button');
      delBtn.textContent = '✕';
      delBtn.className = 'delete-btn';
      delBtn.title = 'Smazat vrstvu';
      delBtn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        canvas.remove(obj);
        if (obj === selectedObject) selectedObject = null;
        canvas.discardActiveObject();
        reorderLayers();
        updateLayerPanel();
        canvas.renderAll();
      });
      li.appendChild(delBtn);

      layerList.appendChild(li);
    });
  }

  function updateEditPanel() {
    const editPanel = document.getElementById('edit-panel');
    const editText = document.getElementById('edit-text');

    if (!selectedObject || !selectedObject.isType('textbox')) {
      editPanel.style.display = 'none';
      return;
    }

    editPanel.style.display = 'block';
    editText.value = selectedObject.text;

    editText.oninput = function () {
      selectedObject.text = this.value;
      canvas.renderAll();
    };
  }

  document.getElementById('inputBackground').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      fabric.Image.fromURL(event.target.result, img => {
        if(userBackgroundImage) canvas.remove(userBackgroundImage);
        img.set({
          left:0, top:0, selectable:false, evented:false, customType:'pozadi'
        });
        img.scaleToWidth(canvas.width);
        img.scaleToHeight(canvas.height);
        canvas.insertAt(img, 0);
        userBackgroundImage = img;
        reorderLayers();
        updateLayerPanel();
        canvas.renderAll();
      });
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('inputPersons').addEventListener('change', e => {
    const files = e.target.files;
    if (!files.length) return;

    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(event) {
        fabric.Image.fromURL(event.target.result, img => {
          img.set({
            left: 300,
            top: 200,
            scaleX: 0.5,
            scaleY: 0.5,
            hasBorders: true,
            hasControls: true,
            selectable: true,
            evented: true,
            hoverCursor: 'move',
            customType: 'osoba'
          });
          canvas.add(img);
          canvas.setActiveObject(img);
          reorderLayers();
          updateLayerPanel();
          canvas.renderAll();
        });
      };
      reader.readAsDataURL(file);
    });
  });

  async function addShadowPredni() {
    if(shadowFrontImage) {
      canvas.remove(shadowFrontImage);
      shadowFrontImage = null;
    }
    shadowFrontImage = await loadImage(assets.shadowPredni, {
      left: 0,
      top: 0,
      selectable: false,
      evented: false,
      opacity: 0.6,
      customType: 'shadowPredni'
    });
    canvas.add(shadowFrontImage);
    reorderLayers();
    updateLayerPanel();
    canvas.renderAll();
  }

  document.getElementById('downloadBtn').addEventListener('click', () => {
    const dataURL = canvas.toDataURL({format: 'png', multiplier: 1});
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = 'voluntia-event.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Delete' || e.key === 'Backspace') {
      const active = canvas.getActiveObject();
      if (active && active.selectable) {
        canvas.remove(active);
        canvas.discardActiveObject();
        reorderLayers();
        updateLayerPanel();
        canvas.renderAll();
      }
    }
  });

  canvas.on('selection:created', (e) => {
    selectedObject = e.target;
    updateLayerPanel();
    updateEditPanel();
  });

  canvas.on('selection:updated', (e) => {
    selectedObject = e.target;
    updateLayerPanel();
    updateEditPanel();
  });

  canvas.on('selection:cleared', (e) => {
    selectedObject = null;
    updateLayerPanel();
    updateEditPanel();
  });

  // Poslední krok - nastavení nasazení
  setupCanvas();
</script>

</body>
</html>

<!-- ... <head> ... (beze změny) -->

<div id="canvas-container">
  <canvas id="eventCanvas" width="1080" height="1080"></canvas>
</div>

<div id="controls">
  <label for="inputTitle">Název akce</label>
  <input type="text" id="inputTitle" value="Voluntia setkání v Liberci" />

  <label for="inputPlace">Místo</label>
  <input type="text" id="inputPlace" value="Pivovarský dvůr, Papírové náměstí" />

  <label for="inputTime">Čas</label>
  <input type="text" id="inputTime" value="25. září v 18:00" />

  <label for="inputAuthor">Zpracovatel</label>
  <input type="text" id="inputAuthor" value="zadavatel/zpracovatel: Voluntia" />

  <label for="inputBackground">Nahrát vlastní pozadí</label>
  <input type="file" id="inputBackground" accept="image/*" />

  <label for="inputPersons">Nahrát fotky osob</label>
  <input type="file" id="inputPersons" multiple accept="image/*" />

  <button id="downloadBtn">Stáhnout obrázek</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
<script>
  const canvas = new fabric.Canvas('eventCanvas', {
    preserveObjectStacking: true,
    selection: true,
    perPixelTargetFind: true,
    targetFindTolerance: 4,
    stopContextMenu: true
  });

  const assets = {
    shadowPozadi: 'assets/Shadow-pozadi.jpg',
    pozadi: 'assets/Celkovy-obrazek.jpg',
    shadowPredni: 'assets/Shadow-predni.jpg',
    spodniLista: 'assets/Spodni-lista.jpg',
    lokaceZnak: 'assets/Lokace-znak.jpg',
    hodinyZnak: 'assets/Hodiny-znak.jpg'
  };

  async function setupCanvas() {
    canvas.clear();

    const pozadi = await loadImage(assets.pozadi, {left: 0, top: 0, selectable: false, customType: 'pozadi'});
    const shadowPozadi = await loadImage(assets.shadowPozadi, {left: 0, top: 0, selectable: false, customType: 'shadowPozadi'});
    
    canvas.add(pozadi);
    canvas.add(shadowPozadi);

    await addShadowPredni();

    const spodniLista = await loadImage(assets.spodniLista, {left: 0, top: 972, selectable: false, customType: 'spodniLista'});
    canvas.add(spodniLista);

    // Ikony - positioning podle originálu
    const lokaceZnak = await loadImage(assets.lokaceZnak, {left: 40, top: 824, selectable: false, width: 37, height: 37, customType: 'lokaceZnak'});
    const hodinyZnak = await loadImage(assets.hodinyZnak, {left: 40, top: 884, selectable: false, width: 37, height: 37, customType: 'hodinyZnak'});
    canvas.add(lokaceZnak);
    canvas.add(hodinyZnak);

    addTextObjects();
    reorderLayers();
    canvas.renderAll();
  }

  let shadowFrontImage = null;
  let texts = {};

  async function loadImage(url, options = {}) {
    return new Promise(resolve => {
      fabric.Image.fromURL(url, img => {
        img.set({...options});
        resolve(img);
      }, {crossOrigin: 'anonymous'});
    });
  }

  async function addShadowPredni() {
    if(shadowFrontImage) canvas.remove(shadowFrontImage);
    shadowFrontImage = await loadImage(assets.shadowPredni, {
      left: 0, top: 0, selectable: false, customType: 'shadowPredni', opacity: 0.67
    });
    canvas.add(shadowFrontImage);
  }

  // Úprava positioning podle originálních obrázků
  function addTextObjects() {
    const fontFamily = 'Inter, sans-serif';
    texts.title = new fabric.Textbox(document.getElementById('inputTitle').value, {
      left: 40, top: 650, fontFamily,
      fontWeight: '900', fontSize: 90, fill: '#fff',
      selectable: false, width: 1000, customType: 'textTitle',
      shadow: new fabric.Shadow({color: 'rgba(0,0,0,0.35)', blur:5, offsetX:0, offsetY:4}),
    });
    texts.place = new fabric.Textbox(document.getElementById('inputPlace').value, {
      left: 93, top: 811, fontFamily,
      fontWeight: '700', fontSize: 50, fill: '#FED801',
      selectable: false, width: 950, customType: 'textPlace',
      shadow: new fabric.Shadow({color: 'rgba(0,0,0,0.25)', blur:2, offsetX:0, offsetY:2}),
    });
    texts.time = new fabric.Textbox(document.getElementById('inputTime').value, {
      left: 93, top: 874, fontFamily,
      fontWeight: '700', fontSize: 50, fill: '#FED801',
      selectable: false, width: 950, customType: 'textTime',
      shadow: new fabric.Shadow({color: 'rgba(0,0,0,0.25)', blur:2, offsetX:0, offsetY:2}),
    });
    texts.author = new fabric.Textbox(document.getElementById('inputAuthor').value || 'zadavatel/zpracovatel: Voluntia', {
      left: 815, top: 930, fontFamily,
      fontWeight: '600', fontSize: 14, fill: 'rgba(255,255,255,0.8)',
      textAlign:'right', selectable:false, width: 250, customType:'textAuthor'
    });
    canvas.add(texts.title, texts.place, texts.time, texts.author);
  }

  function reorderLayers() {
    const objs = canvas.getObjects();
    const pozadi = objs.find(o => o.customType === 'pozadi');
    const shadowPozadi = objs.find(o => o.customType === 'shadowPozadi');
    const osoby = objs.filter(o => o.customType === 'osoba');
    const shadowPredni = objs.find(o => o.customType === 'shadowPredni');
    const spodniLista = objs.find(o => o.customType === 'spodniLista');
    const lokaceZnak = objs.find(o => o.customType === 'lokaceZnak');
    const hodinyZnak = objs.find(o => o.customType === 'hodinyZnak');
    const textTitle = objs.find(o => o.customType === 'textTitle');
    const textPlace = objs.find(o => o.customType === 'textPlace');
    const textTime = objs.find(o => o.customType === 'textTime');
    const textAuthor = objs.find(o => o.customType === 'textAuthor');

    let idx = 0;
    if (pozadi) canvas.moveTo(pozadi, idx++);
    if (shadowPozadi) canvas.moveTo(shadowPozadi, idx++);
    osoby.forEach(o => canvas.moveTo(o, idx++));
    if (shadowPredni) canvas.moveTo(shadowPredni, idx++);
    if (spodniLista) canvas.moveTo(spodniLista, idx++);
    if (lokaceZnak) canvas.moveTo(lokaceZnak, idx++);
    if (hodinyZnak) canvas.moveTo(hodinyZnak, idx++);
    if (textTime) canvas.moveTo(textTime, idx++);
    if (textPlace) canvas.moveTo(textPlace, idx++);
    if (textTitle) canvas.moveTo(textTitle, idx++);
    if (textAuthor) canvas.moveTo(textAuthor, idx++);
  }

  document.getElementById('inputBackground').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      fabric.Image.fromURL(event.target.result, img => {
        if(userBackgroundImage) canvas.remove(userBackgroundImage);
        img.set({
          left: 0,
          top: 0,
          selectable: false,
          evented: false,
          customType: 'pozadi'
        });
        img.scaleToWidth(canvas.width);
        img.scaleToHeight(canvas.height);
        canvas.insertAt(img, 0);
        userBackgroundImage = img;
        reorderLayers();
        canvas.renderAll();
      });
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('inputPersons').addEventListener('change', e => {
    const files = e.target.files;
    if (!files.length) return;

    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(event) {
        fabric.Image.fromURL(event.target.result, img => {
          img.set({
            left: 300,
            top: 250,
            scaleX: 0.7,
            scaleY: 0.7,
            hasBorders: true,
            hasControls: true,
            selectable: true,
            evented: true,
            hoverCursor: 'move',
            customType: 'osoba'
          });
          canvas.add(img);
          canvas.setActiveObject(img);
          reorderLayers();
          canvas.renderAll();
        });
      };
      reader.readAsDataURL(file);
    });
  });

  document.getElementById('downloadBtn').addEventListener('click', () => {
    const dataURL = canvas.toDataURL({format: 'png', multiplier: 1});
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = 'voluntia-event.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  document.addEventListener('keydown', e => {
    if (e.key === "Delete" || e.key === "Backspace") {
      const active = canvas.getActiveObject();
      if (active && active.selectable) {
        canvas.remove(active);
        canvas.discardActiveObject();
        reorderLayers();
        canvas.renderAll();
      }
    }
  });

  ['inputTitle', 'inputPlace', 'inputTime', 'inputAuthor'].forEach(id => {
    document.getElementById(id).addEventListener('input', e => {
      const val = e.target.value;
      switch(e.target.id) {
        case 'inputTitle': if(texts.title) texts.title.text = val; break;
        case 'inputPlace': if(texts.place) texts.place.text = val; break;
        case 'inputTime': if(texts.time) texts.time.text = val; break;
        case 'inputAuthor': if(texts.author) texts.author.text = val || 'zadavatel/zpracovatel: Voluntia'; break;
      }
      canvas.renderAll();
    });
  });

  setupCanvas();
</script>

</body>
</html>
